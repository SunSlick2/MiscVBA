Option Explicit

Private WithEvents btnQATSearch As Office.CommandBarButton

' Initialize when Outlook starts
Private Sub Application_Startup()
    AddSearchDropdownToQAT
End Sub

Private Sub AddSearchDropdownToQAT()
    On Error Resume Next
    
    Dim qat As Office.CommandBar
    Set qat = Application.ActiveExplorer.CommandBars("Standard")
    
    ' Remove existing button to avoid duplicates
    Dim ctrl As Office.CommandBarControl
    For Each ctrl In qat.Controls
        If ctrl.Tag = "QAT_SearchDropdown" Then
            ctrl.Delete
            Exit For
        End If
    Next ctrl
    
    ' Add button at the END of QAT
    Set btnQATSearch = qat.Controls.Add( _
        Type:=msoControlButton, _
        Before:=qat.Controls.Count + 1, _
        Temporary:=False)
    
    With btnQATSearch
        .Caption = "Quick Search"
        .Style = msoButtonIconAndCaption
        .Tag = "QAT_SearchDropdown"
        .TooltipText = "Click for search options"
        .FaceId = 192  ' Search icon
    End With
    
    On Error GoTo 0
End Sub

' Handle button click - show dropdown menu
Private Sub btnQATSearch_Click(ByVal Ctrl As Office.CommandBarButton, _
                               CancelDefault As Boolean)
    ShowSearchDropdown
End Sub

Private Sub ShowSearchDropdown()
    Dim dropdownMenu As Office.CommandBar
    
    ' Create dropdown menu
    Set dropdownMenu = Application.CommandBars.Add( _
        Name:="SearchDropdownMenu", _
        Position:=msoBarPopup, _
        Temporary:=True)
    
    With dropdownMenu
        ' Search Option 1 - Clicking executes immediately
        .Controls.Add(Type:=msoControlButton).Caption = _
            "'Run' emails to abc.com (previous business day)"
        .Controls(.Controls.Count).OnAction = "SearchRunEmails"  ' Will execute immediately when clicked
        
        ' Search Option 2 - Clicking executes immediately
        .Controls.Add(Type:=msoControlButton).Caption = _
            "Search for 'ABC_'"
        .Controls(.Controls.Count).OnAction = "SearchABC"  ' Will execute immediately when clicked
        
        ' Separator
        .Controls.Add Type:=msoControlSeparator
        
        ' Clear Search button at the END of menu
        .Controls.Add(Type:=msoControlButton).Caption = _
            "Clear Search Results"
        .Controls(.Controls.Count).OnAction = "ClearSearchResults"
        .Controls(.Controls.Count).FaceId = 156  ' X icon
    End With
    
    ' Show dropdown menu - when user clicks an item, it executes immediately
    dropdownMenu.ShowPopup
    
    ' Clean up menu after use
    Application.CommandBars("SearchDropdownMenu").Delete
End Sub

' Search 1: 'Run' emails to abc.com from previous business day
Public Sub SearchRunEmails()
    Dim searchFilter As String
    Dim prevBusinessDay As Date
    
    ' Calculate previous business day
    prevBusinessDay = GetPreviousBusinessDay(Date)
    
    ' Build search filter - using Outlook's preferred syntax
    searchFilter = Chr(34) & "Run" & Chr(34) & _
        " sentto:abc.com received:" & _
        Format(prevBusinessDay, "yyyy-mm-dd")
    
    ' Execute search immediately
    ExecuteSearch searchFilter
End Sub

' Search 2: Search for ABC_
Public Sub SearchABC()
    Dim searchFilter As String
    
    ' Simple search for ABC_
    searchFilter = "ABC_"
    
    ' Execute search immediately
    ExecuteSearch searchFilter
End Sub

Private Function GetPreviousBusinessDay(ByVal currentDate As Date) As Date
    Dim prevDay As Date
    
    prevDay = DateAdd("d", -1, currentDate)
    
    ' Adjust for weekends
    Select Case Weekday(prevDay, vbMonday)
        Case 6: prevDay = DateAdd("d", -1, prevDay)  ' Saturday -> Friday
        Case 7: prevDay = DateAdd("d", -2, prevDay)  ' Sunday -> Friday
    End Select
    
    GetPreviousBusinessDay = prevDay
End Function

Private Sub ExecuteSearch(ByVal searchFilter As String)
    Dim explorer As Explorer
    Set explorer = Application.ActiveExplorer
    
    On Error Resume Next
    
    ' Clear existing search
    explorer.ClearSearch
    DoEvents  ' Allow time for clear to complete
    
    ' Execute new search
    explorer.Search searchFilter, olSearchScopeAllOutlookItems
    
    ' Optional: Show brief status in status bar
    Application.StatusBar = "Searching: " & Left(searchFilter, 40) & "..."
    
    ' Clear status bar after 3 seconds
    Application.OnTime Now + TimeValue("00:00:03"), "ClearStatusBar"
    
    On Error GoTo 0
End Sub

Public Sub ClearSearchResults()
    On Error Resume Next
    Application.ActiveExplorer.ClearSearch
    Application.StatusBar = "Search results cleared"
    Application.OnTime Now + TimeValue("00:00:02"), "ClearStatusBar"
    On Error GoTo 0
End Sub

Public Sub ClearStatusBar()
    Application.StatusBar = False
End Sub

' Clean up on exit
Private Sub Application_Quit()
    ' Button persists between sessions - no cleanup needed
End Sub