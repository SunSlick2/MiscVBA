Option Explicit

Dim WithEvents btnQATSearch As Office.CommandBarButton

' Initialize when Outlook starts
Private Sub Application_Startup()
    AddSearchDropdownToQAT
End Sub

Private Sub AddSearchDropdownToQAT()
    On Error Resume Next
    
    Dim qat As Office.CommandBar
    Set qat = Application.ActiveExplorer.CommandBars("Standard")
    
    ' Remove existing button to avoid duplicates
    Dim ctrl As Office.CommandBarControl
    For Each ctrl In qat.Controls
        If ctrl.Tag = "QAT_SearchDropdown" Then
            ctrl.Delete
            Exit For
        End If
    Next ctrl
    
    ' Add button at the END of QAT
    Set btnQATSearch = qat.Controls.Add(Type:=msoControlButton, _
        Before:=qat.Controls.Count + 1, _
        Temporary:=False)
    
    With btnQATSearch
        .Caption = "Quick Search"
        .Style = msoButtonIconAndCaption
        .Tag = "QAT_SearchDropdown"
        .TooltipText = "Click for search options"
        .FaceId = 192  ' Search icon
    End With
    
    On Error GoTo 0
End Sub

' Handle button click - show dropdown menu
Private Sub btnQATSearch_Click(ByVal Ctrl As Office.CommandBarButton, _
                               CancelDefault As Boolean)
    ShowSearchDropdown
End Sub

Private Sub ShowSearchDropdown()
    Dim dropdownMenu As Office.CommandBar
    Dim ctrl As Office.CommandBarControl
    
    ' Create dropdown menu
    Set dropdownMenu = Application.CommandBars.Add( _
        Name:="SearchDropdownMenu", _
        Position:=msoBarPopup, _
        Temporary:=True)
    
    ' Search Option 1
    Set ctrl = dropdownMenu.Controls.Add(Type:=msoControlButton)
    ctrl.Caption = "'Run' emails to abc.com (previous business day)"
    ctrl.OnAction = "SearchRunEmails"
    
    ' Search Option 2
    Set ctrl = dropdownMenu.Controls.Add(Type:=msoControlButton)
    ctrl.Caption = "Search for 'ABC_'"
    ctrl.OnAction = "SearchABC"
    
    ' Add separator (using hyphen as caption)
    Set ctrl = dropdownMenu.Controls.Add(Type:=msoControlButton)
    ctrl.Caption = "-"
    
    ' Clear Search button at the END of menu
    Set ctrl = dropdownMenu.Controls.Add(Type:=msoControlButton)
    ctrl.Caption = "Clear Search Results"
    ctrl.OnAction = "ClearSearchResults"
    
    ' Show dropdown menu
    dropdownMenu.ShowPopup
    
    ' Clean up menu after use
    On Error Resume Next
    Application.CommandBars("SearchDropdownMenu").Delete
    On Error GoTo 0
End Sub

' Search 1: 'Run' emails to abc.com from previous business day
Public Sub SearchRunEmails()
    Dim searchFilter As String
    Dim prevBusinessDay As Date
    
    ' Calculate previous business day
    prevBusinessDay = GetPreviousBusinessDay(Date)
    
    ' Build search filter
    searchFilter = Chr(34) & "Run" & Chr(34) & _
        " sentto:abc.com received:" & _
        Format(prevBusinessDay, "yyyy-mm-dd")
    
    ' Execute search immediately
    ExecuteSearch searchFilter
End Sub

' Search 2: Search for ABC_
Public Sub SearchABC()
    Dim searchFilter As String
    
    ' Simple search for ABC_
    searchFilter = "ABC_"
    
    ' Execute search immediately
    ExecuteSearch searchFilter
End Sub

Private Function GetPreviousBusinessDay(ByVal currentDate As Date) As Date
    Dim prevDay As Date
    
    prevDay = DateAdd("d", -1, currentDate)
    
    ' Adjust for weekends
    Select Case Weekday(prevDay, vbMonday)
        Case 6: prevDay = DateAdd("d", -1, prevDay)  ' Saturday -> Friday
        Case 7: prevDay = DateAdd("d", -2, prevDay)  ' Sunday -> Friday
    End Select
    
    GetPreviousBusinessDay = prevDay
End Function

Private Sub ExecuteSearch(ByVal searchFilter As String)
    Dim explorer As Explorer
    
    On Error Resume Next
    Set explorer = Application.ActiveExplorer
    
    If Not explorer Is Nothing Then
        ' Clear existing search
        explorer.ClearSearch
        DoEvents  ' Allow time for clear to complete
        
        ' Execute new search
        explorer.Search searchFilter, olSearchScopeAllOutlookItems
        
        ' Show brief status
        Application.StatusBar = "Searching: " & Left(searchFilter, 40)
        
        ' Clear status bar after 2 seconds
        Application.OnTime Now + TimeValue("00:00:02"), "ClearStatusBar"
    End If
    
    On Error GoTo 0
End Sub

Public Sub ClearSearchResults()
    On Error Resume Next
    
    Dim explorer As Explorer
    Set explorer = Application.ActiveExplorer
    
    If Not explorer Is Nothing Then
        explorer.ClearSearch
        Application.StatusBar = "Search results cleared"
        Application.OnTime Now + TimeValue("00:00:02"), "ClearStatusBar"
    End If
    
    On Error GoTo 0
End Sub

Public Sub ClearStatusBar()
    Application.StatusBar = False
End Sub

' Clean up on exit
Private Sub Application_Quit()
    ' Button persists between sessions - no cleanup needed
End Sub